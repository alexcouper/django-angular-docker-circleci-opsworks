machine:
  environment:
    DJANGO_TEST_MODE: 1
  timezone:
    Europe/London
  python:
    version: 3.4.0
  services:
    - docker

dependencies:
  pre:
    - pip3 install -r review/requirements/base.txt
    - pip3 install -r review/requirements/test.txt
    - pip3 install -r review/requirements/deployment.txt

test:
  override:
    - cd review; ./run_django_tests.sh

deployment:
  hub:
    branch: circleci_poc
    commands:
      - envsubst < dockercfg.template > ~/.dockercfg
      - ./build_and_push_image.sh app
      - python3 review/manage.py collectstatic --noinput
      - ./build_and_push_image.sh static
      - python3 deploy_to_opsworks.py app
